<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- <meta name="viewport"
    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" /> -->
  <meta name="HandheldFriendly" content="true" />
  <meta name="description" content="Personal My Contacts" />
  <meta name="theme-color" content="#0635c9" />
  <title>My Contacts</title>
  <link rel="manifest" href="./public/manifest.json" />
  <link rel="stylesheet" href="./src/styles/main.css" />
  <link rel="icon" type="image/x-icon" href="./public/favicon.ico" />
  <script defer src="./src/assets/alpinejs@3xx_cdn.min.js"></script>
</head>

<body>
  <div class="flex flex-col h-full" x-data="modalData()" x-init="
    window.addEventListener('close-modal', event => { modalOpen = !event.detail.open; });
    window.addEventListener('detail-modal', event => { modalOpen = !event.detail.open;});
    ">
    <!-- middle x-data="{ modalOpen: false, modalTabState: 'detail'}" x-init="window.addEventListener('detail-modal', event => { modalOpen = !event.detail.open;})" -->
    <div class="relative flex-grow bg-white">
      <!-- top -->
      <div class="fixed z-20 top-0 left-0 w-full">
        <div class="text-center py-3 bg-[#0635c9]">
          <h1 class="text-2xl font-normal text-white">My Contacts</h1>
          <!-- <app-input type="text" id="serachKeyword"
            class="flex-1 py-3 px-4 w-4/6 border border-slate-200 rounded-md text-sm" name="search_keyword"
            data-label="검색" value="" placeholder="이름, 전화번호, 팀 검색"></app-input> -->
        </div>

      </div>

      <div class="contactWrap">

        <!-- scroll-shadows -->
        <div class="w-full h-full">
          <div id="contact-list">
          </div>
        </div>

      </div>

      <!-- Button -->
      <div
        class="button-tap z-50 fixed bottom-0 lelf-0 flex justify-center items-center gap-x-2 md:gap-x-8 w-full h-auto pt-1 pb-3 bg-white border-t border-gray-100">
        <app-tab-button id="list" data-icon="list-outline">
          <span slot="label">목록</span>
        </app-tab-button>
        <app-tab-button id="add" data-icon="add-outline" class="remove-overflow"
          x-on:click="if (modalTabState !== 'add') { modalOpen = true; modalTabState = 'add'; } else { modalOpen = !modalOpen; modalState = ''; }">
          <span slot="label">등록</span>
        </app-tab-button>
        <app-tab-button id="search" data-icon="search-outline" class="remove-overflow"
          x-on:click="if (modalTabState !== 'search') { modalOpen = true; modalTabState = 'search'; } else { modalOpen = !modalOpen; modalState = ''; }">
          <span slot="label">검색</span>
        </app-tab-button>
        <app-tab-button id="data" data-icon="server-outline" class="remove-overflow"
          x-on:click="if (modalTabState !== 'data') { modalOpen = true; modalTabState = 'data'; } else { modalOpen = !modalOpen; modalState = ''; }">
          <span slot="label">데이터</span>
        </app-tab-button>
      </div>

    </div>

    <!-- Contact Detail Modal -->
    <div
      x-show="modalOpen && modalState === 'detail' || modalOpen && modalTabState === 'add' && modalState === 'detail'"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-x-20 opacity-0"
      x-transition:enter-end="transform translate-x-0 opacity-100" x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="transform translate-x-0 opacity-100"
      x-transition:leave-end="transform translate-x-20 opacity-0"
      class="modalDetail z-20 fixed top-0 left-0 bg-slate-200 w-full">
      <!-- header -->
      <div class="z-40 absolute top-0 left-2">
        <app-button id="closeDetailModal" data-iconName="chevron-back-outline" data-iconSize="small"
          class="remove-overflow transparent md" @click="handleOutsideClick"></app-button>
      </div>
      <div class="z-40 absolute top-0 right-2 flex items-center">

        <app-button id="openEditModal" data-iconName="create-outline" data-iconSize="small" class="transparent"
          x-on:click="if (modalTabState !== 'edit') { modalOpen = true; modalTabState = 'edit'; }"
          data-fullName="${eventData.full_name}" data-rank="${eventData.rank}" data-position="${eventData.position}"
          data-division_name="${eventData.division_name}" data-team_name="${eventData.team_name}"
          data-extension_number="${eventData.extension_number}"
          data-personal_phone_number="${eventData.personal_phone_number}"
          data-office_phone_number="${eventData.office_phone_number}" data-email_address="${eventData.email_address}"
          data-photo_url="${eventData.photo_url}"></app-button>

        <app-button id="contact_id" data-iconName="trash-outline" data-iconSize="small"
          class="contact_id remove-overflow transparent" onclick="deleteContact(this.id)"
          @click="handleOutsideClick"></app-button>

      </div>
      <!-- Contents -->
      <div
        class="detailHeader relative overflow-hidden flex flex-col justify-center items-center gap-y-3 h-40 bg-[#22326E]">
        <div
          class="absolute z-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex justify-center items-center w-24 h-24 bg-white rounded-full overflow-hidden">
          <p class="family_name font-semibold text-3xl text-blue-600 hidden">
            성
          </p>
          <img src="" class="photo_url_img hidden" />
        </div>
        <div class="photo_url_bg"></div>
      </div>
      <div class="scroll-shadows">
        <!-- Contact Info -->
        <div class="flex flex-col gap-y-2 mt-2">
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">이름</span>
            <span class="full_name">-</span>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">소속 본부</span>
            <span class="division_name">-</span>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">소속 팀</span>
            <span class="team_name">-</span>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">직책</span>
            <span class="position">-</span>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">직급</span>
            <span class="rank">-</span>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">회사</span>
            <a href="" class="office_phone_number hover:text-blue-600">-</a>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">내선</span>
            <span class="extension_number">-</span>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">개인</span>
            <a href="" class="personal_phone_number hover:text-blue-600">-</a>
          </div>
          <div class="p-4 bg-white">
            <span class="inline-block w-20 font-semibold">이메일</span>
            <span class="email_address">-</span>
          </div>
          <div class="p-4 bg-white flex items-center">
            <span class="inline-block w-20 font-semibold">사진 URL</span>
            <span
              class="photo_url inline-block max-w-[200px] text-ellipsis overflow-hidden whitespace-nowrap text-nowrap">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Modal -->
    <div x-show="modalOpen && modalTabState === 'data'" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-y-20 opacity-0"
      x-transition:enter-end="transform translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform translate-y-0 opacity-100"
      x-transition:leave-end="transform translate-y-20 opacity-0"
      class="container fixed z-40 left-1/2 -translate-x-1/2 bottom-[72px] h-36 bg-slate-50 rounded-tl-2xl rounded-tr-2xl">
      <div class="flex justify-start items-center flex-col p-4 gap-y-2">
        <div class="w-full text-center">
          <h2 class="font-bold text-xl">연락처 데이터 등록</h2>
          <button
            class="remove-overflow absolute top-4 right-4 bg-white rounded-full shadow-xl w-6 h-6 flex items-center justify-center border border-gray-200 focus:bg-gray-100 active:bg-gray-200"
            @click="handleOutsideClick">
            <ion-icon name="close-outline" size="small"></ion-icon>
          </button>
        </div>
        <div class="flex gap-x-2 w-full">
          <div class="py-4 px-5 w-full flex justify-between gap-x-2">
            <!-- <form id="contact-form" autocomplete="off"> -->
            <app-modal-input type="file" id="import_file"></app-modal-input>

            <!-- </form> -->
            <app-button type="button" role="button" data-iconName="cloud-upload-outline" data-iconSize="small"
              id="import_button" for="import_file" class="flex-1">
              <span slot="label">업로드</span>
            </app-button>
            <app-button type="button" role="button" data-iconName="checkmark-outline" data-iconSize="small"
              id="apply_button" class="flex-1 primary hidden" @click="handleOutsideClick">
              <span slot="label">적용하기</span>
            </app-button>
            <app-button type="button" role="button" data-iconName="cloud-download-outline" data-iconSize="small"
              id="export_button" class="flex-1 success">
              <span slot="label">다운로드</span>
            </app-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div x-show="modalOpen && modalTabState === 'search'" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-y-20 opacity-0"
      x-transition:enter-end="transform translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform translate-y-0 opacity-100"
      x-transition:leave-end="transform translate-y-20 opacity-0"
      class="container fixed z-40 left-1/2 -translate-x-1/2 bottom-[72px] h-32 bg-slate-50 rounded-tl-2xl rounded-tr-2xl shadow-slate-600 shadow-2xl">
      <div class="flex justify-start items-center flex-col p-4 gap-y-2">
        <div class="w-full text-center">
          <h2 class="font-bold text-xl">연락처 검색</h2>
          <button
            class="remove-overflow absolute top-4 right-4 bg-white rounded-full shadow-xl w-6 h-6 flex items-center justify-center border border-gray-200 focus:bg-gray-100 active:bg-gray-200"
            @click="handleOutsideClick">
            <ion-icon name="close-outline" size="small"></ion-icon>
          </button>
          </app-button>
        </div>
        <form action="" class="w-full" autocomplete="off">
          <div class="flex gap-x-2 w-full">
            <input type="text" placeholder="이름, 전화번호, 팀 검색"
              class="flex-1 py-3 px-4 w-4/6 border border-slate-200 rounded-md text-sm" />
            <button type="submit" role="button"
              class="py-2 px-4 w-2/6 font-semibold text-sm text-white rounded-md bg-slate-700">
              검색
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ADD Modal -->
    <div id="addEdit" x-show="modalOpen && modalTabState === 'add' || modalOpen && modalTabState === 'edit'"
      data-modal-state="addEdit" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-y-20 opacity-0"
      x-transition:enter-end="transform translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform translate-y-0 opacity-100"
      x-transition:leave-end="transform translate-y-20 opacity-0">
      <div
        class="container fixed z-40 left-1/2 -translate-x-1/2 bottom-[72px] bg-gray-50 h-auto rounded-tl-2xl rounded-tr-2xl">
        <div class="text-center border-b p-4">
          <h2 class="font-semibold text-xl">
            연락처
            <span x-show="modalTabState === 'add'">등록</span>
            <span x-show="modalTabState === 'edit'">수정</span>
            <span x-show="modalTabState === 'detail'">상세</span>
          </h2>

          <button
            class="remove-overflow absolute top-4 right-4 bg-white rounded-full shadow-xl w-6 h-6 flex items-center justify-center border border-gray-200 focus:bg-gray-100 active:bg-gray-200"
            @click="handleOutsideClick">
            <ion-icon name="close-outline" size="small"></ion-icon>
          </button>
        </div>
        <form id="contact-form" autocomplete="off">
          <div class="overflow-y-auto max-h-80 px-6 bg-slate-100 scroll-shadows">
            <app-modal-select id="contact_group_select" name="contact_group" data-label="연락처 그룹" value="" class="mt-2"
              required="true"></app-modal-select>
            <div class="testWrap"></div>

            <!-- <app-modal-input type="text" id="contact_group_input" class="hidden" name="contact_group"
              data-label="연락처 그룹" value="" required="true"></app-modal-input> -->

            <app-modal-input type="text" id="full_name" name="full_name" data-label="이름"
              required="true"></app-modal-input>

            <app-modal-input type="text" id="personal_phone_number" name="personal_phone_number" data-label="개인 전화"
              value="" required="true"></app-modal-input>

            <div id="more-button" class="mt-4" x-show="!contactMore">
              <app-button @click="contactMore = true" type="button" role="button" data-iconName="add-circle-outline"
                data-iconSize="small" class="flex-1 small bg-transparent">
                <span slot="label" for="import_file">추가 입력</span>
              </app-button>
            </div>

            <div id="optional-field" x-show="contactMore">
              <h4 class="text-sm text-blue-700 mt-8 mb-2">
                추가 입력
              </h4>
              <app-modal-input type="text" id="division_name" name="division_name" data-label="소속 본부"
                value=""></app-modal-input>

              <app-modal-input type="text" id="team_name" name="team_name" data-label="소속 팀" value=""></app-modal-input>

              <app-modal-input type="text" id="position" name="position" data-label="직책" value=""></app-modal-input>

              <app-modal-input type="text" id="rank" name="rank" data-label="직급" value=""></app-modal-input>

              <app-modal-input type="text" id="office_phone_number" name="office_phone_number" data-label="회사 전화"
                value=""></app-modal-input>

              <app-modal-input type="number" id="extension_number" name="extension_number" data-label="내선 번호"
                value=""></app-modal-input>

              <app-modal-input type="email" id="email_address" name="email_address" data-label="이메일"
                value=""></app-modal-input>

              <app-modal-input type="text" id="status" name="status" data-label="상태" value=""></app-modal-input>

              <app-modal-input type="text" id="photo_url" name="photo_url" data-label="사진 URL"
                value=""></app-modal-input>
            </div>
          </div>

          <div class="py-4 px-5 shadow-2xl w-full flex justify-between gap-x-2">
            <app-button x-show="modalTabState === 'add'" id="save_contact_button" type="submit" role="button"
              data-iconName="save-outline" data-iconSize="small" data-method="post" class="flex-1 primary"> <!-- click="requiredFieldsCheck()" -->
              <span slot="label">등록</span>
            </app-button>

            <app-button x-show="modalTabState === 'edit'" id="update_contact_button" type="submit" role="button"
              data-iconName="create-outline" data-iconSize="small" data-method="put"
              class="update_contact_button flex-1 success">
              <span slot="label">수정</span>
            </app-button>
          </div>
        </form>
      </div>
    </div>

    <!-- 모달 배경 수정된 코드 -->
    <div
      x-show="modalOpen && ( modalTabState === 'add' || modalTabState === 'data' || modalTabState === 'search' || modalTabState === 'edit' )"
      @click="handleOutsideClick"
      class="remove-overflow z-30 fixed top-0 left-0 w-full h-screen bg-black opacity-70 cursor-pointer"
      x-transition:enter="transition" x-transition:enter-start="transform opacity-0"
      x-transition:enter-end="transform opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform opacity-100" x-transition:leave-end="transform opacity-0"></div>
  </div>
  <!-- Script -->
  <script>

    const modalData = {
      modalOpen: false,
      modalState: "",
      modalTabState: "",
      contactMore: false,
    }


    document.addEventListener('alpine:init', () => {
      Alpine.data('modalData', () => (
        modalData
      ));
    })

    document.addEventListener("detail-modal", function (e) {
      const modalDetail = document.querySelector(".modalDetail");
      const eventData = e.detail;

      const dataMapping = {
        ".full_name": "textContent",
        ".rank": "textContent",
        ".position": "textContent",
        ".division_name": "textContent",
        ".team_name": "textContent",
        ".extension_number": "textContent",
        ".personal_phone_number": "href",
        ".office_phone_number": "href",
        ".email_address": "textContent",
        ".photo_url": "textContent",
      };

      Object.keys(dataMapping).forEach(selector => {
        const property = dataMapping[selector];
        const element = modalDetail.querySelector(selector);
        const parentDiv = element.closest('div'); // 부모 div 요소를 찾습니다.
        parentDiv.classList.remove("hidden");

        if (property === "textContent") {
          if (eventData[selector.slice(1)] === undefined || eventData[selector.slice(1)] === "") {
            // 데이터가 비어있으면 부모 div에 hidden 클래스를 추가합니다.
            parentDiv.classList.add("hidden");
          } else {
            element.textContent = eventData[selector.slice(1)];
            element.classList.remove("hidden");
          }
        } else if (property === "href") {
          if (eventData[selector.slice(1)] === undefined || eventData[selector.slice(1)] === "") {
            // 데이터가 비어있으면 부모 div에 hidden 클래스를 추가합니다.
            parentDiv.classList.add("hidden")
          } else {
            element.href = `tel:${eventData[selector.slice(1)]}`;
            element.textContent = eventData[selector.slice(1)];
            parentDiv.classList.remove("hidden"); // 데이터가 있으면 hidden 클래스를 제거합니다.
          }
        }
      });

      // 모달 내부의 버튼에 ID 값을 동적으로 할당
      const contactButtons = document.querySelectorAll(".contact_id");

      contactButtons.forEach(contactButton => {
        contactButton.setAttribute('id', eventData.contact_id);
      });


      const photoUrlElement = modalDetail.querySelector(".photo_url_img");
      const photoUrlBgElement = modalDetail.querySelector(".photo_url_bg");
      const familyNameElement = modalDetail.querySelector(".family_name");

      if (eventData.photo_url.length > 0) {
        photoUrlElement.src = eventData.photo_url;
        photoUrlBgElement.style.backgroundImage = `url(${eventData.photo_url})`;
        photoUrlElement.classList.remove("hidden");
        photoUrlBgElement.classList.remove("hidden");
      } else if (!eventData.photo_url && eventData.photo_url === "") {
        familyNameElement.textContent = eventData.family_name;
        familyNameElement.classList.remove("hidden");
        console.log("실행?");
      }

    });

    let contactData;

    document.addEventListener("edit-modal", function (e) {
      contactData = e.detail;
    });

    document.getElementById('openEditModal').addEventListener("click", function (e) {

      function countNonEmptyFields(contactData) {
        let nonEmptyCount = 0;

        for (const key of Object.keys(contactData)) {
          if (contactData[key] === '') {
            nonEmptyCount++;
          }
        }

        console.log(`Number of non-empty fields: ${nonEmptyCount}`);
        return nonEmptyCount;
      }

      const fieldCount = countNonEmptyFields(contactData);
      console.log('fieldCount', fieldCount);
      const contactMoreButton = document.querySelector('#more-button app-button');
      const contactMoreContents = document.querySelector('#optional-field')

      if (fieldCount <= 3) {
        contactMoreButton.click();
        console.log('fieldCount more <= 3 count!');
      }

      // contact_id
      let update_contact_button = document.querySelector('.update_contact_button');
      update_contact_button.setAttribute('id', contactData.contact_id);

      // contact_group
      let contactGroup = document.getElementById('contact_group_select').shadowRoot.querySelector('#contact_group_select');
      contactGroup.value = contactData.contact_group;
      console.log(contactData.contact_group)

      // fullName
      let fullName = document.getElementById('full_name').shadowRoot.querySelector('#full_name');
      fullName.value = contactData.full_name;

      // rank
      let rank = document.getElementById('rank').shadowRoot.querySelector('#rank');
      rank.value = contactData.rank;

      // position
      let position = document.getElementById('position').shadowRoot.querySelector('#position');
      position.value = contactData.position;

      // division_name
      let divisionName = document.getElementById('division_name').shadowRoot.querySelector('#division_name');
      divisionName.value = contactData.division_name;

      // team_name
      let teamName = document.getElementById('team_name').shadowRoot.querySelector('#team_name');
      teamName.value = contactData.team_name;

      // photo_url
      let photoUrl = document.getElementById('photo_url').shadowRoot.querySelector('#photo_url');
      photoUrl.value = contactData.photo_url;

      // personal_phone_number
      let personalPhoneNumber = document.getElementById('personal_phone_number').shadowRoot.querySelector('#personal_phone_number');
      personalPhoneNumber.value = contactData.personal_phone_number;

      // office_phone_number
      let officePhoneNumber = document.getElementById('office_phone_number').shadowRoot.querySelector('#office_phone_number');
      officePhoneNumber.value = contactData.office_phone_number;

      // extension_number
      let extensionNumber = document.getElementById('extension_number').shadowRoot.querySelector('#extension_number');
      extensionNumber.value = contactData.extension_number;

      // status
      let status = document.getElementById('status').shadowRoot.querySelector('#status');
      status.value = contactData.status.text;

      // email_address
      let emailAddress = document.getElementById('email_address').shadowRoot.querySelector('#email_address');
      emailAddress.value = contactData.email_address;

    });


  </script>

  <script type="module" src="./src/components/Button/app-button.js"></script>
  <script type="module" src="./src/components/TabButton/app-tab-button.js"></script>
  <script type="module" src="./src/components/ListCard/app-list-card.js"></script>
  <script type="module" src="./src/components/ModalInput/app-modal-input.js"></script>
  <script type="module" src="./src/components/ModalSelect/app-modal-select.js"></script>
  <script type="module" src="./src/services/excelService.js"></script>
  <script type="module" src="./src/eventHandlers/contactFunction.js"></script>
  <script type="module" src="./src/main.js"></script>
  <script src="./src/utils/modalUtils.js"></script>

  <script src="./src/assets/tailwindcss.js"></script>
  <script src="./src/assets/dexie.js"></script>
  <script src="./src/assets/xlsx.full.min.js"></script>

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>

</html>