<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- <meta name="viewport"
    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover" /> -->
  <meta name="HandheldFriendly" content="true" />
  <meta name="description" content="Personal My Contacts" />
  <meta name="theme-color" content="#0635c9" />
  <title>My Contacts</title>
  <link rel="manifest" href="./public/manifest.json" />
  <link rel="stylesheet" href="./src/styles/main.css" />
  <link rel="icon" type="image/x-icon" href="./public/favicon.ico" />
  <script defer src="./src/assets/alpinejs@3xx_cdn.min.js"></script>
</head>

<body>
  <div class="flex flex-col h-full" x-data="{ modalOpen: false, modalState: '' }" x-init="
    window.addEventListener('close-modal', event => {
        modalOpen = event.detail.open;
    })">
    <!-- middle-->
    <div class="container relative mx-auto flex-grow bg-white" x-data="{ modalOpen: false, modalState: 'detail'}"
      x-init="window.addEventListener('detail-modal', event => { modalOpen = !event.detail.open;})">
      <!-- top -->
      <div class="container fixed z-20 top-0 left-0">
        <div class="text-center py-3 bg-[#0635c9]">

          <div x-show="modalOpen && modalState === 'detail'" class="absolute top-0 left-2 flex items-center h-full">
            <app-button data-iconName="chevron-back-outline" data-iconSize="large" class="remove-overflow transparent"
              x-on:click="modalOpen = !modalOpen"></app-button>
          </div>
          <h1 class="text-2xl font-normal text-white">My Contacts <span x-text=""></span></h1>
          
        </div>
      </div>

      <div class="contactWrap">
        <!-- scroll-shadows -->
        <div class="w-full h-full">
          <div id="contact-list" class="pt-[56px]"></div>
        </div>
      </div>

      <!-- Contact Detail Modal -->
      <div x-show="modalOpen && modalState === 'detail'" @click.outside="handleOutsideClick"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="transform translate-x-20 opacity-0"
        x-transition:enter-end="transform translate-x-0 opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform translate-x-0 opacity-100"
        x-transition:leave-end="transform translate-x-20 opacity-0"
        class="modalDetail container z-30 fixed top-14 bg-slate-200 w-full">
        <!-- header -->
        <div class="scroll-shadows">
          <!-- Contents -->
          <div class="flex flex-col justify-center items-center gap-y-3 h-40 bg-[#0635c9]">
            <div class="flex justify-center items-center w-24 h-24 bg-white rounded-full overflow-hidden">
              <p class="family_name font-semibold text-3xl text-blue-600">
                성
              </p>
              <img src="./public/" class="photo_url" />
            </div>
          </div>

          <!-- Contact Info -->
          <div class="flex flex-col gap-y-2 mt-2">
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">이름</span>
              <span class="full_name">-</span>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">소속 본부</span>
              <span class="division_name">-</span>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">소속 팀</span>
              <span class="team_name">-</span>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">직책</span>
              <span class="position">-</span>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">직급</span>
              <span class="rank">-</span>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">회사</span>
              <a href="" class="office_phone_number hover:text-blue-600">-</a>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">내선</span>
              <span class="extension_number">-</span>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">개인</span>
              <a href="" class="personal_phone_number hover:text-blue-600">-</a>
            </div>
            <div class="p-4 bg-white">
              <span class="inline-block w-20 font-semibold">이메일 주소</span>
              <span class="email_address">-</span>
            </div>
            <div class="p-4 bg-white flex items-center">
              <span class="inline-block w-20 font-semibold">사진 URL</span>
              <span
                class="photo_url inline-block max-w-[200px] text-ellipsis overflow-hidden whitespace-nowrap text-nowrap">-</span>
            </div>
            <div class="flex gap-x-2 px-2 pb-4">
              <!-- <app-button type="button" role="button" data-iconName="trash-outline" data-iconSize="small"
                id="deleteContact" data-id="contact-id" class="flex-1 danger">
                <span slot="label">삭제</span>
              </app-button> -->

              <app-button type="button" role="button" data-iconName="trash-outline" data-iconSize="small"
                id="contact-id" class="remove-overflow flex-1 danger" onclick="deleteContact(this.id)"
                @click="modalOpen = !modalOpen">
                <span slot="label">삭제</span>
              </app-button>
              <app-button type="button" role="button" data-iconName="create-outline" data-iconSize="small"
                class="flex-1 success">
                <span slot="label">수정</span>
              </app-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Button -->
    <div
      class="button-tap container z-50 fixed bottom-0 left-1/2 -translate-x-1/2 flex justify-center items-center gap-x-2 md:gap-x-8 h-auto pt-1 pb-3 bg-white border-t border-gray-100">
      <app-tab-button id="list" data-icon="list-outline">
        <span slot="label">목록</span>
      </app-tab-button>
      <app-tab-button id="add" data-icon="add-outline" class="remove-overflow"
        x-on:click="if (modalState !== 'add') { modalOpen = true; modalState = 'add'; } else { modalOpen = !modalOpen; }">
        <span slot="label">등록</span>
      </app-tab-button>
      <app-tab-button id="search" data-icon="search-outline" class="remove-overflow"
        x-on:click="if (modalState !== 'search') { modalOpen = true; modalState = 'search'; } else { modalOpen = !modalOpen; }">
        <span slot="label">검색</span>
      </app-tab-button>
      <app-tab-button id="data" data-icon="server-outline" class="remove-overflow"
        x-on:click="if (modalState !== 'data') { modalOpen = true; modalState = 'data'; } else { modalOpen = !modalOpen; }">
        <span slot="label">데이터</span>
      </app-tab-button>
    </div>

    <!-- Data Modal -->
    <div x-show="modalOpen && modalState === 'data'"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-y-20 opacity-0"
      x-transition:enter-end="transform translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform translate-y-0 opacity-100"
      x-transition:leave-end="transform translate-y-20 opacity-0"
      class="container fixed z-40 left-1/2 -translate-x-1/2 bottom-[72px] h-36 bg-slate-50 rounded-tl-2xl rounded-tr-2xl">
      <div class="flex justify-start items-center flex-col p-4 gap-y-2">
        <div class="w-full text-center">
          <h2 class="font-bold text-xl">연락처 데이터 등록</h2>
          <button
            class="remove-overflow absolute top-4 right-4 bg-white rounded-full shadow-xl w-6 h-6 flex items-center justify-center border border-gray-200 focus:bg-gray-100 active:bg-gray-200"
            x-on:click="modalOpen = ! modalOpen">
            <ion-icon name="close-outline" size="small"></ion-icon>
          </button>
        </div>
        <div class="flex gap-x-2 w-full">
          <div class="py-4 px-5 w-full flex justify-between gap-x-2">
            <!-- <form id="contact-form" autocomplete="off"> -->
            <app-modal-input type="file" id="import_file"></app-modal-input>

            <!-- </form> -->
            <app-button type="button" role="button" data-iconName="cloud-upload-outline" data-iconSize="small"
              id="import_button" for="import_file" class="flex-1">
              <span slot="label">업로드</span>
            </app-button>
            <app-button type="button" role="button" data-iconName="checkmark-outline" data-iconSize="small"
              id="apply_button" class="flex-1 primary hidden">
              <span slot="label">적용하기</span>
            </app-button>
            <app-button type="button" role="button" data-iconName="cloud-download-outline" data-iconSize="small"
              id="export_button" class="flex-1 success">
              <span slot="label">다운로드</span>
            </app-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div x-show="modalOpen && modalState === 'search'"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-y-20 opacity-0"
      x-transition:enter-end="transform translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform translate-y-0 opacity-100"
      x-transition:leave-end="transform translate-y-20 opacity-0"
      class="container fixed z-40 left-1/2 -translate-x-1/2 bottom-[72px] h-32 bg-slate-50 rounded-tl-2xl rounded-tr-2xl shadow-slate-600 shadow-2xl">
      <div class="flex justify-start items-center flex-col p-4 gap-y-2">
        <div class="w-full text-center">
          <h2 class="font-bold text-xl">연락처 검색</h2>
          <button
            class="remove-overflow absolute top-4 right-4 bg-white rounded-full shadow-xl w-6 h-6 flex items-center justify-center border border-gray-200 focus:bg-gray-100 active:bg-gray-200"
            x-on:click="modalOpen = !modalOpen">
            <ion-icon name="close-outline" size="small"></ion-icon>
          </button>
          </app-button>
        </div>
        <form action="" class="w-full" autocomplete="off">
          <div class="flex gap-x-2 w-full">
            <input type="text" placeholder="이름, 전화번호, 팀 검색"
              class="flex-1 py-3 px-4 border border-slate-200 rounded-md text-sm" />
            <button type="submit" role="button"
              class="bg-slate-700 py-2 px-4 font-semibold text-sm text-white rounded-md">
              검색
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ADD Modal -->
    <div x-show="modalOpen && modalState === 'add'"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="transform translate-y-20 opacity-0"
      x-transition:enter-end="transform translate-y-0 opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform translate-y-0 opacity-100"
      x-transition:leave-end="transform translate-y-20 opacity-0">
      <div
        class="container fixed z-40 left-1/2 -translate-x-1/2 bottom-[72px] bg-gray-50 h-auto rounded-tl-2xl rounded-tr-2xl">
        <div class="text-center border-b p-4">
          <h2 class="font-semibold text-xl">
            연락처
            <span x-show="modalState === 'add'">등록</span>
            <span x-show="modalState === 'edit'">수정</span>
            <span x-show="modalState === 'detail'">상세</span>
          </h2>

          <button
            class="remove-overflow absolute top-4 right-4 bg-white rounded-full shadow-xl w-6 h-6 flex items-center justify-center border border-gray-200 focus:bg-gray-100 active:bg-gray-200"
            x-on:click="modalOpen = !modalOpen">
            <ion-icon name="close-outline" size="small"></ion-icon>
          </button>
        </div>
        <form id="contact-form" autocomplete="off">
          <div class="overflow-y-auto max-h-80 px-6 bg-slate-100 scroll-shadows">
            <app-modal-select id="contact_group" name="contact_group" class="mt-2"></app-modal-select>

            <app-modal-input type="text" id="contact_group_input" name="contact_group" data-label="연락처 그룹" value=""
              class="hidden"></app-modal-input>

            <app-modal-input type="text" id="full_name" name="full_name" data-label="이름" value=""
              required="true"></app-modal-input>

            <app-modal-input type="text" id="division_name" name="division_name" data-label="소속 본부" value=""
              required="true"></app-modal-input>

            <app-modal-input type="text" id="team_name" name="team_name" data-label="소속 팀" value=""
              required="true"></app-modal-input>

            <app-modal-input type="text" id="position" name="position" data-label="직책" value=""
              required="true"></app-modal-input>

            <app-modal-input type="text" id="rank" name="rank" data-label="직급" value=""
              required="true"></app-modal-input>

            <app-modal-input type="text" id="personal_phone_number" name="personal_phone_number" data-label="개인 전화"
              value="" required="true"></app-modal-input>

            <app-modal-input type="text" id="office_phone_number" name="office_phone_number" data-label="회사 전화" value=""
              required="true"></app-modal-input>

            <app-modal-input type="number" id="extension_number" name="extension_number" data-label="내선 번호" value=""
              required="true"></app-modal-input>

            <app-modal-input type="email" id="email_address" name="email_address" data-label="이메일" value=""
              required="true"></app-modal-input>

            <app-modal-input type="text" id="status" name="status" data-label="상태" value=""></app-modal-input>

            <app-modal-input type="text" id="photo_url" name="photo_url" data-label="사진 URL" value=""></app-modal-input>
          </div>

          <div class="py-4 px-5 shadow-2xl w-full flex justify-between gap-x-2">
            <app-button type="submit" role="button" data-iconName="save-outline" data-iconSize="small"
              class="flex-1 primary">
              <span slot="label" for="import_file">등록</span>
            </app-button>
          </div>
        </form>
      </div>
    </div>

    <!-- 모달 배경 수정된 코드 -->
    <div x-show="modalOpen && (modalState === 'add' || 'data' || 'search')"
      @click="handleOutsideClick"
      class="remove-overflow z-30 fixed top-0 left-0 w-full h-screen bg-black opacity-70 cursor-pointer"
      x-transition:enter="transition" x-transition:enter-start="transform opacity-0"
      x-transition:enter-end="transform opacity-100" x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="transform opacity-100" x-transition:leave-end="transform opacity-0"></div>
  </div>
  <!-- Script -->
  <script>
    document.addEventListener("detail-modal", function (e) {
      const modalDetail = document.querySelector(".modalDetail");
      const eventData = e.detail;

      const dataMapping = {
        ".full_name": "textContent",
        ".rank": "textContent",
        ".position": "textContent",
        ".division_name": "textContent",
        ".team_name": "textContent",
        ".extension_number": "textContent",
        ".personal_phone_number": "href",
        ".office_phone_number": "href",
        ".email_address": "textContent"
      };

      Object.keys(dataMapping).forEach(selector => {
        const property = dataMapping[selector];
        const element = modalDetail.querySelector(selector);
        const parentDiv = element.closest('div'); // 부모 div 요소를 찾습니다.

        if (property === "textContent") {
          if (eventData[selector.slice(1)] === "") {
            // 데이터가 비어있으면 부모 div에 hidden 클래스를 추가합니다.
            parentDiv.classList.add("hidden");
          } else {
            element.textContent = eventData[selector.slice(1)];
            parentDiv.classList.remove("hidden"); // 데이터가 있으면 hidden 클래스를 제거합니다.
          }
        } else if (property === "href") {
          if (eventData[selector.slice(1)] === "") {
            // 데이터가 비어있으면 부모 div에 hidden 클래스를 추가합니다.
            parentDiv.classList.add("hidden");
          } else {
            element.href = `tel:${eventData[selector.slice(1)]}`;
            element.textContent = eventData[selector.slice(1)];
            parentDiv.classList.remove("hidden"); // 데이터가 있으면 hidden 클래스를 제거합니다.
          }
        }
      });

      const contactButton = modalDetail.querySelector("app-button");
      contactButton.setAttribute("id", eventData.contact_id);

      const photoUrlElement = modalDetail.querySelector(".photo_url");
      const familyNameElement = modalDetail.querySelector(".family_name");

      if (eventData.photo_url && eventData.photo_url.length === 0 || !eventData.photo_url) {
        photoUrlElement.classList.add("hidden");
        familyNameElement.classList.remove("hidden");
        familyNameElement.textContent = eventData.family_name;
      } else {
        familyNameElement.classList.add("hidden");
        photoUrlElement.classList.remove("hidden");
        photoUrlElement.src = eventData.photo_url;
      }
    });

  </script>

  <script type="module" src="./src/components/Button/app-button.js"></script>
  <script type="module" src="./src/components/TabButton/app-tab-button.js"></script>
  <script type="module" src="./src/components/ListCard/app-list-card.js"></script>
  <script type="module" src="./src/components/ModalInput/app-modal-input.js"></script>
  <script type="module" src="./src/components/ModalSelect/app-modal-select.js"></script>
  <script type="module" src="./src/services/excelService.js"></script>
  <script type="module" src="./src/main.js"></script>
  <script src="./src/utils/modalUtils.js"></script>

  <script src="./src/assets/tailwindcss.js"></script>
  <script src="./src/assets/dexie.js"></script>
  <script src="./src/assets/xlsx.full.min.js"></script>

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>

</html>